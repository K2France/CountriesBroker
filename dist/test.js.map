{"version":3,"file":"test.js","sources":["../src/test.ts"],"sourcesContent":["import test from 'ava';\nimport '@k2oss/k2-broker-core/test-framework';\nimport './index';\n\nfunction mock(name: string, value: any) \n{\n    global[name] = value;\n}\n\ntest('describe returns the hardcoded instance', async t => {\n    let schema = null;\n    mock('postSchema', function(result: any) {\n        schema = result;\n    });\n\n    await Promise.resolve<void>(ondescribe());\n    \n    t.deepEqual(schema, {\n        objects: {\n            \"com.k2.todo\": {\n                displayName: \"TODO\",\n                description: \"Manages a TODO list\",\n                properties: {\n                    \"com.k2.todo.id\": {\n                        displayName: \"ID\",\n                        type: \"number\"\n                    },\n                    \"com.k2.todo.userId\": {\n                        displayName: \"User ID\",\n                        type: \"number\"\n                    },\n                    \"com.k2.todo.title\": {\n                        displayName: \"Title\",\n                        type: \"string\"\n                    },\n                    \"com.k2.todo.completed\": {\n                        displayName: \"Completed\",\n                        type: \"boolean\"\n                    }\n                },\n                methods: {\n                    \"com.k2.todo.get\": {\n                        displayName: \"Get TODO\",\n                        type: \"read\",\n                        inputs: [ \"com.k2.todo.id\" ],\n                        outputs: [ \"com.k2.todo.id\", \"com.k2.todo.userId\", \"com.k2.todo.title\", \"com.k2.todo.completed\" ]\n                    }\n                }\n            }\n        }\n    });\n\n    t.pass();\n});\n\ntest('execute fails with the wrong parameters', async t => {\n    let error = await t.throwsAsync(Promise.resolve<void>(onexecute('test1', 'unused', {}, {})));\n    \n    t.deepEqual(error.message, 'The object test1 is not supported.');\n\n    error = await t.throwsAsync(Promise.resolve<void>(onexecute('com.k2.todo', 'test2', {}, {})));\n    \n    t.deepEqual(error.message, 'The method test2 is not supported.');\n\n    t.pass();\n});\n\ntest('execute passes', async t => {\n\n    let xhr: {[key:string]: any} = null;\n    class XHR {\n        public onreadystatechange: () => void;\n        public readyState: number;\n        public status: number;\n        public responseText: string;\n        private recorder: {[key:string]: any};\n\n        constructor() {\n            xhr = this.recorder = {};\n            this.recorder.headers = {};\n        }\n\n        open(method: string, url: string) {\n            this.recorder.opened = {method, url};   \n        }\n\n        setRequestHeader(key: string, value: string) {\n            this.recorder.headers[key] = value;\n        }\n\n        send() {\n            queueMicrotask(() =>\n            {\n                this.readyState = 4;\n                this.status = 200;\n                this.responseText = JSON.stringify({\n                    \"id\": 123,\n                    \"userId\": 51,\n                    \"title\": \"Groceries\",\n                    \"completed\": false\n                });\n                this.onreadystatechange();\n                delete this.responseText;\n            });\n        }\n    }\n\n    mock('XMLHttpRequest', XHR);\n\n    let result: any = null;\n    function pr(r: any) {\n        result = r;\n    }\n\n    mock('postResult', pr);\n\n    await Promise.resolve<void>(onexecute(\n        'com.k2.todo', 'com.k2.todo.get', {}, {\n            \"com.k2.todo.id\": 123\n        }));\n\n    t.deepEqual(xhr, {\n        opened: {\n            method: 'GET',\n            url: 'https://jsonplaceholder.typicode.com/todos/123'\n        },\n        headers: {\n            'test': 'test value'\n        }\n    });\n\n    t.deepEqual(result, {\n        \"com.k2.todo.id\": 123,\n        \"com.k2.todo.userId\": 51,\n        \"com.k2.todo.title\": \"Groceries\",\n        \"com.k2.todo.completed\": false\n    });\n\n    t.pass();\n});"],"names":["mock","name","value","global","test","async","schema","result","Promise","resolve","ondescribe","t","deepEqual","objects","displayName","description","properties","type","methods","inputs","outputs","pass","error","throwsAsync","onexecute","message","xhr","constructor","this","recorder","headers","open","method","url","opened","setRequestHeader","key","send","queueMicrotask","readyState","status","responseText","JSON","stringify","onreadystatechange","r"],"mappings":"4KAIA,SAASA,EAAKC,EAAcC,GAExBC,OAAOF,GAAQC,qEAGnBE,EAAK,0CAA2CC,MAAAA,QACxCC,EAAS,KACbN,EAAK,cAAc,SAASO,GACxBD,EAASC,WAGPC,QAAQC,QAAcC,cAE5BC,EAAEC,UAAUN,EAAQ,CAChBO,QAAS,eACU,CACXC,YAAa,OACbC,YAAa,sBACbC,WAAY,kBACU,CACdF,YAAa,KACbG,KAAM,+BAEY,CAClBH,YAAa,UACbG,KAAM,8BAEW,CACjBH,YAAa,QACbG,KAAM,kCAEe,CACrBH,YAAa,YACbG,KAAM,YAGdC,QAAS,mBACc,CACfJ,YAAa,WACbG,KAAM,OACNE,OAAQ,CAAE,kBACVC,QAAS,CAAE,iBAAkB,qBAAsB,oBAAqB,+BAO5FT,EAAEU,SAGNjB,EAAK,0CAA2CC,MAAAA,QACxCiB,QAAcX,EAAEY,YAAYf,QAAQC,QAAce,UAAU,QAAS,SAAU,GAAI,MAEvFb,EAAEC,UAAUU,EAAMG,QAAS,sCAE3BH,QAAcX,EAAEY,YAAYf,QAAQC,QAAce,UAAU,cAAe,QAAS,GAAI,MAExFb,EAAEC,UAAUU,EAAMG,QAAS,sCAE3Bd,EAAEU,SAGNjB,EAAK,iBAAkBC,MAAAA,QAEfqB,EAA2B,KAsC/B1B,EAAK,uBA9BD2B,cACID,EAAME,KAAKC,SAAW,QACjBA,SAASC,QAAU,GAG5BC,KAAKC,EAAgBC,QACZJ,SAASK,OAAS,CAACF,OAAAA,EAAQC,IAAAA,GAGpCE,iBAAiBC,EAAalC,QACrB2B,SAASC,QAAQM,GAAOlC,EAGjCmC,OACIC,eAAe,UAENC,WAAa,OACbC,OAAS,SACTC,aAAeC,KAAKC,UAAU,IACzB,WACI,SACD,uBACI,SAEZC,4BACEhB,KAAKa,sBAOpBlC,EAAc,KAKlBP,EAAK,uBAJO6C,GACRtC,EAASsC,WAKPrC,QAAQC,QAAce,UACxB,cAAe,kBAAmB,GAAI,kBAChB,OAG1Bb,EAAEC,UAAUc,EAAK,CACbQ,OAAQ,CACJF,OAAQ,MACRC,IAAK,kDAETH,QAAS,MACG,gBAIhBnB,EAAEC,UAAUL,EAAQ,kBACE,yBACI,uBACD,qCACI,IAG7BI,EAAEU"}